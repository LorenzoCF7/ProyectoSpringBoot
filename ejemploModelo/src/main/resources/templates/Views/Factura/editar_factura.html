<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Factura</title>
    <link rel="stylesheet" th:href="@{/styles.css}">
</head>
<body>
<div class="container">
    <div class="header">
        <h1>Editar Factura</h1>
        <p>Actualiza la informaci√≥n de la factura</p>
    </div>

    <form th:action="@{/facturas/{id}/actualizar(id=${factura.id})}" th:object="${factura}" method="post">

        <div class="form-group">
            <label for="suscripcion">Suscripci√≥n Asociada:</label>
            <select id="suscripcion" name="suscripcion" required>
                <option value="">-- Selecciona una suscripci√≥n --</option>
                <option th:each="suscripcion : ${suscripciones}" th:value="${suscripcion.id}"
                        th:data-precio="${suscripcion.plan != null ? suscripcion.plan.precio : 0}"
                        th:data-pais="${suscripcion.usuario != null ? suscripcion.usuario.pais : 'ESPA√ëA'}"
                        th:text="${'ID: ' + suscripcion.id + ' - Usuario: ' + (suscripcion.usuario != null ? suscripcion.usuario.email : 'N/A') + ' - Plan: ' + (suscripcion.plan != null ? suscripcion.plan.nombre : 'N/A')}"
                        th:selected="${factura.suscripcion != null and factura.suscripcion.id == suscripcion.id}"></option>
            </select>
        </div>

        <div class="form-group">
            <label for="descripcion">Descripci√≥n:</label>
            <input type="text" id="descripcion" th:field="*{descripcion}" placeholder="Descripci√≥n de la factura" required>
        </div>

        <div class="form-group">
            <label for="monto">Monto:</label>
            <input type="number" id="monto" th:field="*{monto}" placeholder="Monto de la factura" step="0.01" required>
        </div>

        <div class="form-group" id="impuestoSection" style="background-color: #f0f9ff; padding: 10px; border-radius: 5px; border-left: 4px solid #3b82f6;">
            <label>Resumen de Impuestos:</label>
            <div style="margin-top: 8px; font-size: 0.95em;">
                <div><strong>Pa√≠s:</strong> <span id="paisDisplay"></span></div>
                <div><strong>Tipo de Impuesto:</strong> <span id="tipoImpuestoDisplay"></span></div>
                <div><strong>Monto Base:</strong> <span id="montoBaseDisplay">0.00</span>‚Ç¨</div>
                <div><strong>Impuesto:</strong> <span id="impuestoDisplay">0.00</span>‚Ç¨</div>
                <div style="border-top: 1px solid #cbd5e1; padding-top: 8px; margin-top: 8px;"><strong style="color: #1e40af;">Monto Total (con impuestos):</strong> ‚Ç¨<span id="montoTotalDisplay" style="font-size: 1.1em; color: #1e40af;">0.00</span></div>
            </div>
        </div>

        <div class="form-group">
            <label for="fechaEmision">Fecha de Emisi√≥n:</label>
            <input type="date" id="fechaEmision" th:field="*{fechaEmision}" required>
        </div>

        <!-- Solo administradores pueden marcar manualmente como pagada -->
        <div class="form-group" sec:authorize="hasRole('ADMIN')">
            <label for="pagada">
                <input type="checkbox" id="pagada" th:field="*{pagada}">
                Factura Pagada (marcar manualmente)
            </label>
            <small style="color: #6b7280; display: block; margin-top: 5px;">
                ‚ÑπÔ∏è Las facturas se marcan autom√°ticamente como pagadas cuando se registra un pago.
            </small>
        </div>

        <!-- Mostrar estado de pago (solo lectura para usuarios normales) -->
        <div class="form-group" sec:authorize="hasRole('USER')" style="background-color: #f0fdf4; padding: 1rem; border-radius: 8px; border-left: 4px solid #10b981;">
            <strong>Estado de Pago:</strong> 
            <span th:text="${factura.pagada} ? '‚úì Pagada' : '‚è≥ Pendiente'" 
                  th:style="${factura.pagada} ? 'color: #059669; font-weight: 600;' : 'color: #f59e0b; font-weight: 600;'"></span>
            <br>
            <small style="color: #6b7280; margin-top: 5px; display: block;">
                üí° Para marcar una factura como pagada, ve a <a href="/pagos/nuevo" style="color: #2563eb; text-decoration: underline;">Registrar Pago</a> y selecciona esta factura.
            </small>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-success">‚úì Guardar Cambios</button>
            <a th:href="@{/facturas/{id}(id=${factura.id})}" class="btn btn-secondary">‚Üê Cancelar</a>
        </div>
    </form>
</div>

<script>
    // Tasas de impuesto por pa√≠s
    const tasasImpuesto = {
        'ESPA√ëA': { tasa: 21.0, tipo: 'IVA' },
        'FRANCIA': { tasa: 20.0, tipo: 'TVA' },
        'ALEMANIA': { tasa: 19.0, tipo: 'MwSt' },
        'ITALIA': { tasa: 22.0, tipo: 'IVA' },
        'PORTUGAL': { tasa: 23.0, tipo: 'IVA' },
        'REINO_UNIDO': { tasa: 20.0, tipo: 'VAT' }
    };

    const montoInput = document.getElementById('monto');
    const suscripcionSelect = document.getElementById('suscripcion');
    const impuestoSection = document.getElementById('impuestoSection');
    
    // Calcular impuestos
    function calcularImpuestos() {
        const selectedOption = suscripcionSelect.options[suscripcionSelect.selectedIndex];
        const pais = selectedOption.dataset.pais || 'ESPA√ëA';
        const monto = parseFloat(montoInput.value) || 0;
        
        const impuestoInfo = tasasImpuesto[pais] || { tasa: 21.0, tipo: 'IVA' };
        const montoImpuesto = monto * (impuestoInfo.tasa / 100);
        const montoTotal = monto + montoImpuesto;
        
        // Actualizar vista
        document.getElementById('paisDisplay').textContent = pais;
        document.getElementById('tipoImpuestoDisplay').textContent = impuestoInfo.tipo + ' ' + impuestoInfo.tasa.toFixed(1) + '%';
        document.getElementById('montoBaseDisplay').textContent = monto.toFixed(2);
        document.getElementById('impuestoDisplay').textContent = montoImpuesto.toFixed(2);
        document.getElementById('montoTotalDisplay').textContent = montoTotal.toFixed(2);
    }
    
    // Recalcular cuando cambia la suscripci√≥n
    suscripcionSelect.addEventListener('change', function() {
        calcularImpuestos();
    });
    
    // Recalcular cuando cambia el monto
    montoInput.addEventListener('input', function() {
        calcularImpuestos();
    });
    
    // Calcular al cargar la p√°gina
    calcularImpuestos();
</script>
</body>
</html>