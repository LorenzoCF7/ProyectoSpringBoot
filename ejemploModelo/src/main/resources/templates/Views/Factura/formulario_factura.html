<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nueva Factura</title>
    <link rel="stylesheet" th:href="@{/styles.css}">
</head>
<body>
<div class="container">
    <div class="header">
        <h1>Nueva Factura</h1>
        <p>Completa el formulario para crear una nueva factura</p>
    </div>

    <form th:action="@{/facturas/guardar}" th:object="${factura}" method="post">

        <div class="form-group">
            <label for="suscripcion">Suscripci√≥n Asociada:</label>
            <select id="suscripcion" name="suscripcion" required>
                <option value="" data-precio="0">-- Selecciona una suscripci√≥n --</option>
                <option th:each="suscripcion : ${suscripciones}" 
                        th:value="${suscripcion.id}" 
                        th:data-precio="${suscripcion.plan != null ? suscripcion.plan.precio : 0}"
                        th:data-pais="${suscripcion.usuario != null ? suscripcion.usuario.pais : 'ESPA√ëA'}"
                        th:text="${'ID: ' + suscripcion.id + ' - Usuario: ' + (suscripcion.usuario != null ? suscripcion.usuario.email : 'N/A') + ' - Plan: ' + (suscripcion.plan != null ? suscripcion.plan.nombre + ' (' + suscripcion.plan.precio + '‚Ç¨)' : 'N/A')}"></option>
            </select>
        </div>

        <div class="form-group">
            <label for="descripcion">Descripci√≥n:</label>
            <input type="text" id="descripcion" th:field="*{descripcion}" placeholder="Descripci√≥n de la factura" required>
        </div>

        <div class="form-group">
            <label for="monto">Monto:</label>
            <input type="number" id="monto" th:field="*{monto}" placeholder="Monto de la factura" step="0.01" required>
            <small style="color: #6b7280;">Se autocompleta seg√∫n el precio del plan (puedes modificarlo)</small>
        </div>

        <div class="form-group" id="impuestoSection" style="display: none; background-color: #f0f9ff; padding: 10px; border-radius: 5px; border-left: 4px solid #3b82f6;">
            <label>Resumen de Impuestos:</label>
            <div style="margin-top: 8px; font-size: 0.95em;">
                <div><strong>Pa√≠s:</strong> <span id="paisDisplay"></span></div>
                <div><strong>Tipo de Impuesto:</strong> <span id="tipoImpuestoDisplay"></span></div>
                <div><strong>Monto Base:</strong> <span id="montoBaseDisplay">0.00</span>‚Ç¨</div>
                <div style="border-top: 1px solid #cbd5e1; padding-top: 8px; margin-top: 8px;"><strong style="color: #1e40af;">Monto Total (con impuestos):</strong> <span id="montoTotalDisplay" style="font-size: 1.1em; color: #1e40af;">0.00</span>‚Ç¨</div>
            </div>
        </div>

        <div class="form-group">
            <label for="fechaEmision">Fecha de Emisi√≥n:</label>
            <input type="date" id="fechaEmision" th:field="*{fechaEmision}" required>
            <small style="color: #6b7280;">Fecha actual por defecto (puedes modificarla)</small>
        </div>

        <!-- Solo administradores pueden marcar manualmente como pagada -->
        <div class="form-group" sec:authorize="hasRole('ADMIN')">
            <label for="pagada">
                <input type="checkbox" id="pagada" th:field="*{pagada}">
                Factura Pagada (marcar manualmente)
            </label>
            <small style="color: #6b7280; display: block; margin-top: 5px;">
                ‚ÑπÔ∏è Las facturas se marcan autom√°ticamente como pagadas cuando se registra un pago.
            </small>
        </div>

        <!-- Info para usuarios normales -->
        <div class="form-group" sec:authorize="hasRole('USER')" style="background-color: #eff6ff; padding: 1rem; border-radius: 8px; border-left: 4px solid #3b82f6;">
            <strong>üí≥ ¬øC√≥mo marcar como pagada?</strong>
            <p style="margin: 0.5rem 0 0 0; color: #6b7280; font-size: 0.9em;">
                Las facturas se marcan autom√°ticamente como pagadas cuando registras un pago. <br>
                Despu√©s de crear esta factura, ve a <a href="/pagos/nuevo" style="color: #2563eb; text-decoration: underline;">Registrar Pago</a>.
            </p>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-success">‚úì Guardar Factura</button>
            <a href="/facturas/listar" class="btn btn-secondary">‚Üê Cancelar</a>
        </div>
    </form>
</div>

<script>
    // Tasas de impuesto por pa√≠s
    const tasasImpuesto = {
        'ESPA√ëA': { tasa: 21.0, tipo: 'IVA' },
        'FRANCIA': { tasa: 20.0, tipo: 'TVA' },
        'ALEMANIA': { tasa: 19.0, tipo: 'MwSt' },
        'ITALIA': { tasa: 22.0, tipo: 'IVA' },
        'PORTUGAL': { tasa: 23.0, tipo: 'IVA' },
        'REINO_UNIDO': { tasa: 20.0, tipo: 'VAT' }
    };

    const fechaEmisionInput = document.getElementById('fechaEmision');
    const montoInput = document.getElementById('monto');
    const suscripcionSelect = document.getElementById('suscripcion');
    const impuestoSection = document.getElementById('impuestoSection');
    
    // Funci√≥n para formatear fecha a YYYY-MM-DD
    function formatDate(date) {
        return date.toISOString().split('T')[0];
    }
    
    // Calcular impuestos
    function calcularImpuestos() {
        const selectedOption = suscripcionSelect.options[suscripcionSelect.selectedIndex];
        const suscripcionId = selectedOption.value;
        
        if (!suscripcionId) {
            impuestoSection.style.display = 'none';
            return;
        }
        
        // Obtener informaci√≥n de la suscripci√≥n desde atributos data
        const pais = selectedOption.dataset.pais || 'ESPA√ëA';
        const monto = parseFloat(montoInput.value) || 0;
        
        const impuestoInfo = tasasImpuesto[pais] || { tasa: 21.0, tipo: 'IVA' };
        const montoImpuesto = monto * (impuestoInfo.tasa / 100);
        const montoTotal = monto + montoImpuesto;
        
        // Actualizar vista
        document.getElementById('paisDisplay').textContent = pais;
        document.getElementById('tipoImpuestoDisplay').textContent = impuestoInfo.tipo + ' ' + impuestoInfo.tasa.toFixed(1) + '%';
        document.getElementById('montoBaseDisplay').textContent = monto.toFixed(2);
        document.getElementById('montoTotalDisplay').textContent = montoTotal.toFixed(2);
        
        impuestoSection.style.display = 'block';
    }
    
    // Establecer fecha de emisi√≥n como hoy
    const hoy = new Date();
    fechaEmisionInput.value = formatDate(hoy);
    
    // Actualizar monto cuando cambia la suscripci√≥n
    suscripcionSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const precio = parseFloat(selectedOption.dataset.precio) || 0;
        montoInput.value = precio.toFixed(2);
        calcularImpuestos();
    });
    
    // Actualizar c√°lculo cuando cambia el monto
    montoInput.addEventListener('input', function() {
        calcularImpuestos();
    });
</script>
</body>
</html>
